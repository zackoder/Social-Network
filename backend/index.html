<!DOCTYPE html>
<html>
  <body>
    <h2>WebSocket Test</h2>

    <textarea id="log" rows="10" cols="50" readonly></textarea><br />

    <form class="msgform">
      <input type="text" id="msgInput" placeholder="Type a message..." />
      <input type="file" />
      <button type="submit">Send</button>
    </form>
    <br /><br />
    <form class="groupform">
      <input type="text" id="groupInput" placeholder="Type a message..." />
      <input type="file" />
      <button type="submit">Send</button>
    </form>

    <script>
      async function creategroups() {
        try {
          for (let i = 0; i < 11; i++) {
            let res = await fetch("/creategroup", {
              method: "POST", // <-- move method here
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ content: "hello there", title: `hi${i}` }),
            });

            let data = await res.json(); // <-- call it with ()
            console.log(data);
          }
        } catch (error) {
          console.error(error);
        }
      }
      // creategroups();

      const params = window.location.search.slice(1).split("&");
      console.log(params);
      const searchparams = {};
      for (let i = 0; i < params.length; i++) {
        let [key, value] = params[i].split("=");
        searchparams[key] = value;
      }

      console.log(searchparams);

      const socket = new WebSocket(
        `ws://localhost:8080/ws?id=${searchparams.id}`
      );
      const form = document.querySelector(".msgform");
      const groupform = document.querySelector(".groupform");

      const data1 = {
        type: "message",
        sender_id: 1,
        reciever_id: 3,
      };

      const data2 = {
        type: "message",
        sender_id: 5,
        group_id: 1,
      };

      sendmessage(form, data1);
      sendmessage(groupform, data2);
      function sendmessage(form, data) {
        form.addEventListener("submit", (e) => {
          e.preventDefault();

          try {
            data.content = form.children[0].value;
            const avatar = form.children[1].files[0];
            console.log("data", data);

            if (!data.combined && !avatar) return;

            if (data.content) {
              socket.send(JSON.stringify(data));
              data.content = "";
            }

            if (avatar) {
              const reader = new FileReader();

              reader.onload = () => {
                try {
                  const arrayBuffer = reader.result;
                  data.type = "image";
                  data.filename = avatar.name;
                  data.mime = avatar.type;

                  const meta = JSON.stringify(data) + "::";

                  const encoder = new TextEncoder();
                  const metaBuffer = encoder.encode(meta);

                  const combined = new Uint8Array(
                    metaBuffer.length + arrayBuffer.byteLength
                  );
                  combined.set(metaBuffer, 0);
                  combined.set(new Uint8Array(arrayBuffer), metaBuffer.length);

                  socket.send(combined.buffer);
                } catch (innerErr) {
                  console.error("Error preparing/sending image:", innerErr);
                }
              };

              reader.onerror = () => {
                console.error("FileReader failed:", reader.error);
              };

              reader.readAsArrayBuffer(avatar);
            }
          } catch (err) {
            console.error("Unexpected error in submit handler:", err);
          }
        });
      }

      socket.onmessage = (event) => {
        console.log("Received:", event.data.json());
      };
    </script>
  </body>
</html>
